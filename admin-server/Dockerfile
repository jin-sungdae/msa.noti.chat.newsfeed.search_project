# Stage 1: ê³µí†µ ëª¨ë“ˆ ë¹Œë“œ
FROM maven:3.8.7-eclipse-temurin-17 AS common-builder
WORKDIR /app/common

COPY common-lib/pom.xml .
COPY common-lib/src ./src
RUN mvn clean install -DskipTests

# Stage 2: admin Server ë¹Œë“œ (WAR íŒŒì¼ ìƒì„±)
FROM maven:3.8.7-eclipse-temurin-17 AS admin-builder
WORKDIR /app/Admin

COPY --from=common-builder /root/.m2 /root/.m2
COPY admin-server/pom.xml .
COPY admin-server/src ./src

RUN mvn clean package -DskipTests

# Stage 3: ì‹¤í–‰ìš© ì»¨í…Œì´ë„ˆ
FROM tomcat:10-jdk17-temurin
WORKDIR /usr/local/tomcat

# unzip íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y unzip

# ê¸°ì¡´ Webapps ì œê±°
RUN rm -rf webapps/*

# Tomcat í¬íŠ¸ ë³€ê²½
RUN sed -i 's/port="8080"/port="1114"/g' /usr/local/tomcat/conf/server.xml

RUN sed -i '/<\/web-app>/i \
  <jsp-config>\n\
    <taglib>\n\
        <taglib-uri>http://jakarta.apache.org/taglibs/standard/permittedTaglibs</taglib-uri>\n\
        <taglib-location>/WEB-INF/lib/jstl.jar</taglib-location>\n\
    </taglib>\n\
  </jsp-config>\n\
' /usr/local/tomcat/conf/web.xml


# WAR íŒŒì¼ ë³µì‚¬
COPY --from=admin-builder /app/Admin/target/admin-server-0.0.1-SNAPSHOT.war webapps/ROOT.war

# ğŸ› ï¸ WAR íŒŒì¼ ì••ì¶• í•´ì œ
RUN mkdir -p /usr/local/tomcat/webapps/ROOT && \
    unzip webapps/ROOT.war -d webapps/ROOT && \
    rm -f webapps/ROOT.war

# ğŸ“‚ lib-providedì—ì„œ libìœ¼ë¡œ íŒŒì¼ ì´ë™ (WAR ì••ì¶• í•´ì œ í›„ ì‹¤í–‰)
RUN if [ -d "/usr/local/tomcat/webapps/ROOT/WEB-INF/lib-provided" ]; then \
        cp -r /usr/local/tomcat/webapps/ROOT/WEB-INF/lib-provided/* /usr/local/tomcat/webapps/ROOT/WEB-INF/lib/; \
    fi

# Tomcat ì‹¤í–‰
CMD ["catalina.sh", "run"]


